<!DOCTYPE html>
<html>
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <link rel="stylesheet" href="style.css" type="text/css" />
    </head>
    <body onload="getLocation()">
<!--        <div id="location">Trying to determine location...</div>-->
        <div id="map"></div>
        
        <script>
            var map;        
            var lat = -99999;
            var lng = -99999;
            
            function getLocation() {
                  navigator.geolocation.getCurrentPosition(function(somePos) {
                      
                      lat = somePos.coords.latitude;
                      lng = somePos.coords.longitude;           

//                      printLocation();
                      startRequest();
                  });
            }
            
            function startRequest() {
                
                var request = new XMLHttpRequest();
                request.open("POST", "https://hans-moleman.herokuapp.com/rides", true);
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                request.onreadystatechange = function () {
                    if (request.readyState == 4 && request.status == 200) {
                        initMap();
                        //alert(request.responseText);
                        var info = JSON.parse(request.responseText);
                    
                        console.log(info);
                        
                        if (info.vehicles) {
                            for (count = 0; count < info.vehicles.length; count++) {

                                var objectLat = info.vehicles[count]["lat"];
                                var objectLng = info.vehicles[count]["lng"];

                               if (info.vehicles[count]["username"] == "WEINERMOBILE") {
                                  createMarker(parseFloat(objectLat), parseFloat(objectLng), "weinermobile"); 
                               } 
                                else { 
                                   createMarker(parseFloat(objectLat), parseFloat(objectLng), "vehicle");
                                }
                            }
                        }
                        if (info.passengers) {
                            for (count = 0; count < info.passengers.length; count++) {

                                var objectLat = info.passengers[count]["lat"];
                                var objectLng = info.passengers[count]["lng"];
                                
                               if (info.passengers[count]["username"] == "WEINERMOBILE") {
                                  createMarker(parseFloat(objectLat), parseFloat(objectLng), "weinermobile"); 
                               } 
                                else { 
                                   createMarker(parseFloat(objectLat), parseFloat(objectLng), "passenger");
                                }

                            }
                        }
                    }
                }

                request.send("username=" + "k8ResZzT" + "&lat=" + lat + "&lng=" + lng);  
            }
              
            function initMap() {

                    var currPos = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));

                    map = new google.maps.Map(document.getElementById('map'), {
                        center: currPos,
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });

                    var contentString = "Username: k8ResZzT <br> Distance away: ...";

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });

                    var myPos = new google.maps.Marker({
                        position: currPos,
                        map: map,
                        icon: 'default.png'
                    });
                    myPos.addListener('click', function() {
                        infowindow.open(map, myPos);
                    });
            }
              
//            function printLocation() {
//              
//                  elem = document.getElementById("location");
//                  elem.innerHTML = '<p class="fun">' + lat + ", " + lng + "</p>";
//            }
            
            function createMarker(objectLat, objectLng, type) {
                  console.log(type);
                    var contentString = "Latitude: " + objectLat + "<br>" + "Longitude: " + objectLng;
                
                    console.log(contentString);

                    var infowindow = new google.maps.InfoWindow({
                        content: contentString
                    });
                
                var image = 'default.png';
                
                if (type == "passenger") {
                    image = 'person.png';
                }
                // accomodate for weinermobile
                else if (type == "vehicle")
                    {
                        image = 'car.png';
                    }
                else if (type == "weinermobile")
                    {
                        image = 'weinermobile.png';
                    }

                var newPos = new google.maps.LatLng(parseFloat(objectLat), parseFloat(objectLng));
                
                    var marker = new google.maps.Marker({
                        position: newPos,
                        map: map,
                        icon: image
                    });     
                
                    marker.addListener('click', function() {
                        infowindow.open(map, marker);
                    });
              }
              
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9sQaGQMUn1TEZG3C11LjRlpQAppS4WGk"
            async defer></script>
    </body>
</html>